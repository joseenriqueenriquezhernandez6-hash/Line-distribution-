<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>K-Pop Line Distribution (Final)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --glass: rgba(255,255,255,0.12); --glass-2: rgba(255,255,255,0.06) }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:"Poppins",sans-serif; -webkit-font-smoothing:antialiased;
    background: linear-gradient(135deg,#ff3cac,#784ba0,#2b86c5);
    background-size:400% 400%; color:white; padding:18px;
    animation:bgShift 12s ease infinite;
  }
  @keyframes bgShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  .wrap{max-width:820px;margin:0 auto}
  header{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
  h1{margin:0;font-size:20px;font-weight:700}

  .panel{background:var(--glass); border-radius:14px; padding:12px; margin-top:14px; backdrop-filter:blur(8px); border:1px solid rgba(255,255,255,0.06)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="text"], input[type="number"]{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.03);color:white;min-width:0}
  input[type="color"]{width:44px;height:38px;border-radius:8px;border:none;padding:0}
  button{padding:10px 14px;border-radius:999px;border:none;cursor:pointer;font-weight:700}
  .btn-primary{background:#00e5ff;color:#04121f}
  .btn-neutral{background:rgba(255,255,255,0.12);color:white}
  .btn-danger{background:#ff6b6b;color:white}

  #members{margin-top:14px;display:flex;flex-direction:column;gap:12px}

  .member {
    display:flex;flex-direction:column;gap:10px;padding:12px;border-radius:12px;
    background:rgba(255,255,255,0.03); /* m√°s transparente */
    border:1px solid rgba(255,255,255,0.02); /* borde m√°s sutil */
    transition:transform .28s,box-shadow .28s,opacity .28s;
  }

  .member-top{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .left{display:flex;align-items:center;gap:12px;min-width:0}
  .avatar-wrap{width:56px;height:56px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;flex-shrink:0;border:3px solid rgba(255,255,255,0.06);transition:transform .22s,border-color .22s,box-shadow .22s}
  .avatar-wrap img{width:100%;height:100%;object-fit:cover;display:block}
  .avatar-initial{font-weight:700;font-size:18px;color:#fff}

  .avatar-wrap.singing{transform:scale(1.10); box-shadow: 0 8px 26px rgba(0,0,0,0.35)}
  .avatar-wrap.glow{box-shadow:0 0 18px var(--color)}

  .member .info{min-width:0}
  .name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .meta{font-size:13px;opacity:0.95}

  .progress-wrap{height:14px;border-radius:10px;background:rgba(255,255,255,0.06);overflow:hidden}
  .progress{height:100%;width:0%;transition:width .12s linear;background:var(--color)}

  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .controls button{flex:1;padding:10px;border-radius:10px}
  .sing{background:#36e27a;color:#022}
  .stop{background:#ff7b7b;color:white}
  .disableBtn{background:#333333;color:white}

  /* member singing effect */
  .member.singing{transform:scale(1.03);box-shadow:0 12px 40px rgba(0,0,0,0.35)}

  /* disabled look */
  .member.disabled{opacity:0.6;filter:grayscale(20%)}

  /* small responsive */
  @media (max-width:600px){
    .avatar-wrap{width:48px;height:48px}
    .controls button{padding:9px}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>K-Pop Line Distribution</h1>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn-neutral" onclick="print()">Export / Print</button>
      <button class="btn-danger" onclick="resetAll()">Reset All</button>
    </div>
  </header>

  <!-- settings panel -->
  <div class="panel">
    <div class="row" style="align-items:center">
      <div style="min-width:200px">
        <label style="display:block;font-size:13px;margin-bottom:6px">Duraci√≥n canci√≥n (min : seg)</label>
        <div style="display:flex;gap:8px">
          <input id="songMin" type="number" placeholder="min" style="width:72px">
          <span style="align-self:center">:</span>
          <input id="songSec" type="number" placeholder="seg" style="width:72px">
        </div>
      </div>
      <div style="min-width:220px">
        <label style="display:block;font-size:13px;margin-bottom:6px">Duraci√≥n total de la l√≠nea (segundos) ‚Äî max para barras</label>
        <input id="lineMax" type="number" min="1" placeholder="Ej: 38" style="width:180px">
      </div>
      <div style="flex:1;min-width:220px">
        <label style="display:block;font-size:13px;margin-bottom:6px">Agregar integrante</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="newName" type="text" placeholder="Nombre">
          <input id="newColor" type="color" value="#ff6b6b">
          <button class="btn-primary" onclick="addMember()">Agregar</button>
        </div>
      </div>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn-neutral" onclick="saveAll()">Guardar distribuci√≥n</button>
      <button class="btn-neutral" onclick="loadAll()">Cargar √∫ltima</button>
      <button class="btn-neutral" onclick="resetDistribution()">Reset Distribution</button>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <label style="font-size:13px">Fondo (color):</label>
      <input type="color" id="bgColor">
      <label style="font-size:13px">Fondo (imagen):</label>
      <input type="file" id="bgImage" accept="image/*">
    </div>
  </div>

  <!-- members -->
  <div id="members"></div>
</div>

<script>
let members = [];
let intervals = {};
const STORAGE_KEY = "kpop_line_dist_final_v1";

(function(){
  loadAll();
  render();
})();

function uid(){ return Date.now().toString(36) + Math.floor(Math.random()*999).toString(36); }
function getLineMax(){ const v = Number(document.getElementById('lineMax').value); return (v>0? v : 50); }

document.getElementById('bgColor').addEventListener('input', e=>{
  document.body.style.backgroundImage = 'none';
  document.body.style.backgroundColor = e.target.value;
});
document.getElementById('bgImage').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{ document.body.style.backgroundImage = `url(${r.result})`; document.body.style.backgroundSize='cover'; document.body.style.backgroundPosition='center'; }
  r.readAsDataURL(f);
});

function addMember(){
  const name = (document.getElementById('newName').value || "").trim();
  const color = document.getElementById('newColor').value || "#ff6b6b";
  const lineMax = getLineMax();
  if(!name){ alert("Escribe un nombre."); return; }

  members.push({ id: uid(), name, color, time:0, finalized:false, disabled:false, avatar:null });
  document.getElementById('newName').value = "";
  render();
}

function saveAll(){
  const songMin = Number(document.getElementById('songMin').value) || 0;
  const songSec = Number(document.getElementById('songSec').value) || 0;
  const lineMax = getLineMax();
  const payload = { members, settings: { songMin, songSec, lineMax } };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  alert("Guardado ‚úî");
}

function loadAll(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return;
  try{
    const parsed = JSON.parse(raw);
    members = (parsed.members||[]).map(m => ({
      id: m.id||uid(),
      name: m.name||'Member',
      color: m.color||'#ff6b6b',
      time: Number(m.time)||0,
      finalized: !!m.finalized,
      disabled: !!m.disabled,
      avatar: m.avatar||null
    }));
    document.getElementById('songMin').value = parsed.settings?.songMin ?? "";
    document.getElementById('songSec').value = parsed.settings?.songSec ?? "";
    document.getElementById('lineMax').value = parsed.settings?.lineMax ?? "";
  }catch(e){ console.error(e) }
  render();
}

function resetAll(){
  if(!confirm("¬øReiniciar TODO? Se borrar√° todo y el guardado.")) return;
  clearAllIntervals();
  members = []; localStorage.removeItem(STORAGE_KEY);
  render();
}
function resetDistribution(){
  if(!confirm("¬øBorrar integrantes y tiempos (mantener ajustes)?")) return;
  clearAllIntervals();
  members = []; render();
}

setInterval(()=> {
  try{
    const songMin = Number(document.getElementById('songMin').value) || 0;
    const songSec = Number(document.getElementById('songSec').value) || 0;
    const lineMax = getLineMax();
    const payload = { members, settings:{ songMin, songSec, lineMax } };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  }catch(e){}
}, 7000);

function render(){
  members.sort((a,b)=> b.time - a.time);
  const container = document.getElementById('members');
  container.innerHTML = "";
  const lineMax = getLineMax();

  members.forEach(m => {
    const percent = lineMax>0 ? Math.min(100, (m.time / lineMax) * 100) : 0;
    const card = document.createElement('div');
    card.className = 'member' + (m.singing? ' singing':'') + (m.disabled? ' disabled':'');

    card.innerHTML = `
      <div class="member-top">
        <div class="left">
          <div class="avatar-wrap" id="avatar-${m.id}" style="--color:${m.color}">
            ${m.avatar ? `<img src="${m.avatar}" alt="${m.name}">` : `<div class="avatar-initial">${(m.name||'?').trim().charAt(0).toUpperCase()}</div>`}
          </div>
          <div class="info">
            <div class="name">${m.name}</div>
            <div class="meta">${m.time.toFixed(1)}s ‚Ä¢ ${percent.toFixed(1)}%</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center"></div>
      </div>
      <div class="progress-wrap">
        <div class="progress" id="progress-${m.id}" style="--color:${m.color}; width:${percent}%"></div>
      </div>
      <div class="controls">
        <button class="sing" ${m.finalized || m.disabled ? 'disabled':''}>Sing</button>
        <button class="stop" ${m.disabled ? 'disabled':''}>Stop</button>
        <button class="disableBtn">${m.disabled? 'üîí':'‚ûñ'}</button>
        <button class="btn-neutral" style="min-width:36px">Subir foto</button>
      </div>
    `;

    container.appendChild(card);

    const singBtn = card.querySelector('.sing');
    const stopBtn = card.querySelector('.stop');
    const disableBtn = card.querySelector('.disableBtn');
    const uploadBtn = card.querySelector('.btn-neutral');
    const avatarWrap = card.querySelector('.avatar-wrap');

    singBtn.onclick = () => startSing(m.id);
    stopBtn.onclick = () => stopSing(m.id);
    disableBtn.onclick = () => toggleDisable(m.id);

    uploadBtn.onclick = () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = (evt) => {
        const file = evt.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const member = members.find(x=>x.id===m.id);
          if(member){ member.avatar = reader.result; render(); }
        };
        reader.readAsDataURL(file);
      };
      input.click();
    };

    avatarWrap.style.setProperty('--color', m.color);
    if(m.singing){ avatarWrap.classList.add('singing','glow'); card.classList.add('singing'); }
    else { avatarWrap.classList.remove('singing','glow'); card.classList.remove('singing'); }

    if(m.disabled){ card.classList.add('disabled'); }
  });
}

function startSing(id){
  const m = members.find(x=>x.id===id);
  if(!m || m.finalized || m.disabled) return;
  if(intervals[id]) return;
  m.singing = true; render();
  intervals[id] = setInterval(()=>{
    const mm = members.find(x=>x.id===id);
    if(!mm || mm.finalized || mm.disabled){ clearInterval(intervals[id]); delete intervals[id]; mm && (mm.singing=false); render(); return; }
    mm.time = Number((mm.time + 0.1).toFixed(1));
    const lineMax = getLineMax();
    if(mm.time >= lineMax){ mm.time = lineMax; mm.finalized = true; clearInterval(intervals[id]); delete intervals[id]; mm.singing=false; }
    render();
  }, 100);
}

function stopSing(id){
  const m = members.find(x=>x.id===id);
  if(!m) return;
  if(intervals[id]){ clearInterval(intervals[id]); delete intervals[id]; }
  m.singing = false;
  render();
}

function toggleDisable(id){
  const m = members.find(x=>x.id===id);
  if(!m) return;
  if(!m.disabled){ if(intervals[id]){ clearInterval(intervals[id]); delete intervals[id]; } m.singing=false; m.disabled=true; }
  else { m.disabled=false; }
  render();
}

function clearAllIntervals(){
  Object.keys(intervals).forEach(k => { clearInterval(intervals[k]); delete intervals[k]; });
}

window.addEventListener('beforeunload', ()=> { clearAllIntervals(); });
function print(){ window.print(); }
function findIndexById(id){ return members.findIndex(m => m.id === id); }
</script>
</body>
</html>
